// ==== CLIENTE LADO DO USU√ÅRIO ====

const socket = io();

// Gerar ID aleat√≥rio para simular usu√°rio
const myUserId = "user" + Math.floor(Math.random() * 10000);
document.getElementById('userIdDisplay').innerText = `üë§ ${myUserId}`;

// Registrar no servidor
socket.emit('register', myUserId);

// ====== ESTADO ======
let unreadCount = 0;
const notificationsMap = new Map(); // Guardar notifica√ß√µes para controlar estado

// ====== SOM DE NOTIFICA√á√ÉO ======
const notifSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj==');

// Reproduzir som com fallback gracioso\nfunction playNotificationSound() {\n    try {\n        notifSound.currentTime = 0;\n        notifSound.play().catch(() => {\n            // Som bloqueado, silenciosamente ignorar\n        });\n    } catch (e) {\n        // Fallback silencioso\n    }\n}\n\n// ====== EVENTOS DO SOCKET ======\n\nsocket.on('connect', () => {\n    updateStatusIndicator(true);\n    console.log('‚úÖ Conectado ao servidor');\n});\n\nsocket.on('disconnect', () => {\n    updateStatusIndicator(false);\n    console.log('‚ùå Desconectado do servidor');\n});\n\n// Receber hist√≥rico ao conectar\nsocket.on('history', (notifications) => {\n    notifList.innerHTML = ''; // Limpar lista\n    if (notifications.length === 0) {\n        notifList.innerHTML = '<p class=\"empty-state\">Aguardando notifica√ß√µes...</p>';\n    } else {\n        notifications.forEach(notif => {\n            renderNotification(notif);\n        });\n    }\n});\n\n// Receber nova notifica√ß√£o\nsocket.on('new_notification', (data) => {\n    renderNotification(data);\n    playNotificationSound();\n    animateNewNotification();\n    updateUnreadCount();\n    \n    // Mostrar notifica√ß√£o nativa se permiss√£o concedida\n    if (Notification.permission === 'granted') {\n        new Notification(data.title, {\n            body: data.message,\n            icon: 'üì¨',\n            badge: 'üì¨',\n            tag: `notif-${data.id}`\n        });\n    }\n});\n\n// Atualizar contagem de n√£o lidas\nsocket.on('unread_count', (count) => {\n    unreadCount = count;\n    updateUnreadCountUI();\n});\n\n// Confirma√ß√£o de leitura\nsocket.on('notification_read', (notifId) => {\n    // UI j√° foi atualizada no cliente lado\n});\n\n// ====== FUN√á√ïES DE RENDERIZA√á√ÉO ======\n\nconst notifList = document.getElementById('notifList');\n\nfunction renderNotification(notif) {\n    // Para de mostrar \"Aguardando notifica√ß√µes\"\n    if (notifList.querySelector('.empty-state')) {\n        notifList.innerHTML = '';\n    }\n\n    notificationsMap.set(notif.id, notif);\n\n    const div = document.createElement('div');\n    div.className = `notif-item ${notif.read ? 'read' : 'unread'}`;\n    div.id = `notif-${notif.id}`;\n    div.innerHTML = `\n        <div class=\"notif-header\">\n            <strong>${notif.title}</strong>\n            <span class=\"notif-time\">${notif.timestamp}</span>\n        </div>\n        <p class=\"notif-text\">${notif.message}</p>\n        <div class=\"notif-status\">\n            <span class=\"status-label\">${notif.read ? '‚úÖ Lida' : '‚ö™ N√£o lida'}</span>\n        </div>\n    `;\n\n    // Marcar como lida ao clicar\n    div.addEventListener('click', () => {\n        if (!notif.read) {\n            notif.read = true;\n            div.classList.remove('unread');\n            div.classList.add('read');\n            div.querySelector('.status-label').textContent = '‚úÖ Lida';\n            socket.emit('mark_as_read', notif.id);\n            unreadCount--;\n            updateUnreadCountUI();\n        }\n    });\n\n    notifList.insertBefore(div, notifList.firstChild);\n}\n\n// ====== ATUALIZAR UI ======\n\nfunction updateUnreadCountUI() {\n    const badge = document.getElementById('unreadCount');\n    badge.textContent = unreadCount;\n    \n    if (unreadCount > 0) {\n        badge.style.display = 'inline-block';\n        document.title = `(${unreadCount}) Central de Notifica√ß√µes`;\n    } else {\n        badge.style.display = 'none';\n        document.title = 'Central de Notifica√ß√µes';\n    }\n}\n\nfunction updateUnreadCount() {\n    unreadCount = Array.from(notificationsMap.values()).filter(n => !n.read).length;\n    updateUnreadCountUI();\n}\n\nfunction updateStatusIndicator(connected) {\n    const indicator = document.getElementById('statusIndicator');\n    if (connected) {\n        indicator.className = 'status-indicator connected';\n        indicator.title = 'Conectado';\n    } else {\n        indicator.className = 'status-indicator disconnected';\n        indicator.title = 'Desconectado';\n    }\n}\n\nfunction animateNewNotification() {\n    const list = notifList;\n    list.style.animation = 'none';\n    setTimeout(() => {\n        list.style.animation = 'slideDown 0.3s ease-out';\n    }, 10);\n}\n\n// ====== BOT√ÉO LIMPAR HIST√ìRICO ======\n\ndocument.getElementById('clearAllBtn').addEventListener('click', () => {\n    if (confirm('Tem certeza que deseja limpar o hist√≥rico?')) {\n        notifList.innerHTML = '<p class=\"empty-state\">Aguardando notifica√ß√µes...</p>';\n        notificationsMap.clear();\n        unreadCount = 0;\n        updateUnreadCountUI();\n    }\n});\n\n// ====== REQUISITAR PERMISS√ÉO DE NOTIFICA√á√ÉO ======\n\nif ('Notification' in window && Notification.permission === 'default') {\n    Notification.requestPermission();\n}\n\n// ====== ANIMAR QUANDO P√ÅGINA GANHA FOCO ======\n\nwindow.addEventListener('focus', () => {\n    // Recarregar notifica√ß√µes do servidor para sincronizar\n    socket.emit('register', myUserId);\n});\n